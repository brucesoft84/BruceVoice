<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 0.9s linear infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .fade-in { animation: fadeIn 0.35s ease both; }
    .drag-over { border-color: #6366f1 !important; background-color: #eef2ff !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-gray-900">

  <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-5 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-lg">üéô</div>
      <div>
        <h1 class="font-bold text-gray-900 leading-tight">Voice Analyzer</h1>
        <p class="text-xs text-gray-400">Vietnamese ¬∑ Pitch ¬∑ Speaker Diarization</p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-5 py-8 space-y-5">

    <!-- ‚îÄ‚îÄ Upload Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="upload-card" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 transition-opacity">

      <!-- Drop zone -->
      <div id="dropzone"
           class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50"
           onclick="document.getElementById('file-input').click()">
        <div class="text-4xl mb-2" id="drop-icon">üìÇ</div>
        <p id="drop-label" class="font-medium text-gray-600">Drop audio file here or <span class="text-indigo-600">click to browse</span></p>
        <p class="text-xs text-gray-400 mt-1">WAV &middot; MP3 &middot; M4A &middot; FLAC &middot; OGG</p>
        <input type="file" id="file-input" accept=".wav,.mp3,.m4a,.flac,.ogg,.aac" class="hidden" />
      </div>

      <!-- File info bar -->
      <div id="file-info" class="hidden mt-4 flex items-center gap-3 bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-3">
        <span class="text-2xl">üéµ</span>
        <div class="flex-1 min-w-0">
          <p id="file-name" class="font-semibold text-gray-800 text-sm truncate"></p>
          <p id="file-size" class="text-xs text-gray-400"></p>
        </div>
        <button onclick="clearFile()" class="text-gray-300 hover:text-red-400 text-xl leading-none transition-colors">&times;</button>
      </div>

      <!-- Options grid -->
      <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Model</label>
          <select id="opt-model" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="tiny">Tiny</option>
            <option value="base">Base</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large" selected>Large</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Speakers</label>
          <input id="opt-speakers" type="number" min="1" max="10" placeholder="Auto"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Device</label>
          <select id="opt-device" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="auto" selected>Auto</option>
            <option value="cpu">CPU</option>
            <option value="cuda">CUDA</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Diarization</label>
          <label class="flex items-center gap-2 mt-2.5 cursor-pointer select-none">
            <input type="checkbox" id="opt-skip-diar" class="w-4 h-4 rounded accent-indigo-600" />
            <span class="text-sm text-gray-600">Skip</span>
          </label>
        </div>
      </div>

      <!-- HF Token -->
      <div class="mt-4">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">
          Hugging Face Token <span class="font-normal normal-case text-gray-400">(required for diarization)</span>
        </label>
        <input id="opt-hf-token" type="password" placeholder="hf_‚Ä¶"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
      </div>

      <!-- Analyze button -->
      <button id="analyze-btn" onclick="startAnalysis()" disabled
              class="mt-6 w-full py-3 rounded-xl font-semibold text-sm transition-all
                     bg-gray-200 text-gray-400 cursor-not-allowed
                     disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed">
        Select a file to analyze
      </button>
    </div>

    <!-- ‚îÄ‚îÄ Progress Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="progress-card" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6 fade-in">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-semibold text-gray-700">Processing</h2>
        <span id="progress-filename" class="text-xs text-gray-400 truncate max-w-[200px]"></span>
      </div>
      <div id="steps-container" class="space-y-5"></div>
    </div>

    <!-- ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="results-root" class="hidden space-y-5 fade-in">

      <!-- Transcript -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-700 flex items-center gap-2">
            <span class="text-indigo-500">üìù</span> Transcript
          </h2>
          <button onclick="copyTranscript(this)"
                  class="text-xs text-indigo-600 hover:text-indigo-800 border border-indigo-200 hover:border-indigo-400 rounded-lg px-3 py-1 transition-colors">
            Copy
          </button>
        </div>
        <p id="result-transcript"
           class="text-sm text-gray-800 leading-relaxed bg-slate-50 rounded-xl p-4 border border-gray-100 whitespace-pre-wrap"></p>
      </div>

      <!-- Pitch -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-5 flex items-center gap-2">
          <span class="text-indigo-500">üìä</span> Pitch Analysis
        </h2>
        <div id="pitch-stats" class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-5"></div>
        <img id="pitch-chart" src="" alt="Pitch contour"
             class="w-full rounded-xl border border-gray-100 bg-gray-50" />
      </div>

      <!-- Diarization -->
      <div id="diar-card" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-5 flex items-center gap-2">
          <span class="text-indigo-500">üë•</span> Speaker Diarization
        </h2>
        <div id="diar-content"></div>
      </div>

      <!-- Analyze another -->
      <button onclick="resetUI()"
              class="w-full py-3 rounded-xl font-semibold text-sm bg-white border border-gray-300
                     hover:border-indigo-400 hover:text-indigo-600 transition-colors text-gray-600">
        ‚Ü© Analyze Another File
      </button>
    </div>

  </main>

  <script>
    // ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SPEAKER_COLORS  = ['#6366f1','#f59e0b','#10b981','#ef4444','#8b5cf6','#06b6d4'];
    const SPEAKER_BG      = ['#eef2ff','#fffbeb','#ecfdf5','#fef2f2','#f5f3ff','#ecfeff'];
    const SPEAKER_BORDER  = ['#c7d2fe','#fde68a','#a7f3d0','#fecaca','#ddd6fe','#a5f3fc'];
    const STEP_DEFS = [
      { id:1, name:'Load & Enhance', icon:'üéµ' },
      { id:2, name:'Transcribe',     icon:'üìù' },
      { id:3, name:'Pitch',          icon:'üìä' },
      { id:4, name:'Diarize',        icon:'üë•' },
      { id:5, name:'Verify',         icon:'‚úÖ' },
    ];

    let selectedFile = null;

    // ‚îÄ‚îÄ Dropzone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dropzone  = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');

    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('drag-over');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    function handleFile(f) {
      selectedFile = f;
      document.getElementById('file-name').textContent = f.name;
      document.getElementById('file-size').textContent = fmtBytes(f.size);
      document.getElementById('file-info').classList.remove('hidden');
      document.getElementById('drop-label').innerHTML =
        'File selected &mdash; <span class="text-indigo-600">click to change</span>';
      const btn = document.getElementById('analyze-btn');
      btn.disabled = false;
      btn.className = btn.className.replace(
        /bg-gray-200 text-gray-400 cursor-not-allowed/,
        'bg-indigo-600 hover:bg-indigo-700 text-white cursor-pointer'
      );
      btn.textContent = 'Analyze Audio';
    }

    function clearFile() {
      selectedFile = null;
      fileInput.value = '';
      document.getElementById('file-info').classList.add('hidden');
      document.getElementById('drop-label').innerHTML =
        'Drop audio file here or <span class="text-indigo-600">click to browse</span>';
      const btn = document.getElementById('analyze-btn');
      btn.disabled = true;
      btn.className = btn.className.replace(
        /bg-indigo-600 hover:bg-indigo-700 text-white cursor-pointer/,
        'bg-gray-200 text-gray-400 cursor-not-allowed'
      );
      btn.textContent = 'Select a file to analyze';
    }

    function fmtBytes(b) {
      if (b < 1024) return b + ' B';
      if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
      return (b/1024/1024).toFixed(1) + ' MB';
    }

    // ‚îÄ‚îÄ Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function startAnalysis() {
      if (!selectedFile) return;

      const fd = new FormData();
      fd.append('file', selectedFile);
      fd.append('model_size', document.getElementById('opt-model').value);
      fd.append('num_speakers', document.getElementById('opt-speakers').value);
      fd.append('device', document.getElementById('opt-device').value);
      fd.append('skip_diarization', document.getElementById('opt-skip-diar').checked ? 'true' : 'false');
      fd.append('hf_token', document.getElementById('opt-hf-token').value);

      // UI transition
      document.getElementById('upload-card').classList.add('opacity-40', 'pointer-events-none');
      document.getElementById('results-root').classList.add('hidden');
      showProgress(selectedFile.name);

      let jobId;
      try {
        const res = await fetch('/analyze', { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`Upload failed: ${res.statusText}`);
        jobId = (await res.json()).job_id;
      } catch (err) { return showError(err.message); }

      const es = new EventSource('/stream/' + jobId);
      es.onmessage = e => handleEvent(JSON.parse(e.data), jobId, es);
      es.onerror   = () => { es.close(); showError('Connection lost'); };
    }

    function handleEvent(ev, jobId, es) {
      if (ev.type === 'progress') {
        setStep(ev.step, ev.status, ev.message, ev.detail);
      } else if (ev.type === 'done') {
        es.close();
        // Mark any still-pending steps as done
        STEP_DEFS.forEach(s => {
          const badge = document.getElementById(`s-badge-${s.id}`);
          if (badge && badge.textContent === '') setStep(s.id, 'done', '', '');
        });
        setTimeout(() => renderResults(ev.results, jobId), 300);
      } else if (ev.type === 'error') {
        es.close();
        showError(ev.message);
      }
    }

    // ‚îÄ‚îÄ Progress rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showProgress(filename) {
      document.getElementById('progress-filename').textContent = filename;
      const c = document.getElementById('steps-container');
      c.innerHTML = STEP_DEFS.map(s => `
        <div class="flex items-start gap-4">
          <div id="s-icon-${s.id}"
               class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-lg select-none">
            ${s.icon}
          </div>
          <div class="flex-1 min-w-0 pt-1.5">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium text-gray-700">${s.name}</span>
              <span id="s-badge-${s.id}" class="text-xs px-2 py-0.5 rounded-full font-medium hidden"></span>
            </div>
            <p id="s-detail-${s.id}" class="text-xs text-gray-400 mt-0.5 truncate"></p>
          </div>
        </div>`).join('');
      document.getElementById('progress-card').classList.remove('hidden');
    }

    function setStep(id, status, message, detail) {
      const icon  = document.getElementById(`s-icon-${id}`);
      const badge = document.getElementById(`s-badge-${id}`);
      const det   = document.getElementById(`s-detail-${id}`);
      if (!icon) return;
      if (detail) det.textContent = detail;

      const configs = {
        running: {
          bg:    'bg-indigo-100',
          inner: `<svg class="w-5 h-5 text-indigo-600 spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                  </svg>`,
          badgeCls: 'bg-indigo-100 text-indigo-700', badgeText: 'Running',
        },
        done: {
          bg:    'bg-green-100',
          inner: '<span class="text-green-600 text-xl font-bold">‚úì</span>',
          badgeCls: 'bg-green-100 text-green-700', badgeText: 'Done',
        },
        warning: {
          bg:    'bg-amber-100',
          inner: '<span class="text-amber-500 text-xl">‚ö†</span>',
          badgeCls: 'bg-amber-100 text-amber-700', badgeText: 'Skipped',
        },
        skipped: {
          bg:    'bg-gray-100',
          inner: '<span class="text-gray-400 text-lg">‚Äî</span>',
          badgeCls: 'bg-gray-100 text-gray-500', badgeText: 'Skipped',
        },
      };

      const cfg = configs[status];
      if (!cfg) return;
      icon.className = `flex-shrink-0 w-10 h-10 rounded-full ${cfg.bg} flex items-center justify-center`;
      icon.innerHTML = cfg.inner;
      badge.className = `text-xs px-2 py-0.5 rounded-full font-medium ${cfg.badgeCls}`;
      badge.textContent = cfg.badgeText;
      badge.classList.remove('hidden');
    }

    // ‚îÄ‚îÄ Results rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderResults(data, jobId) {
      document.getElementById('upload-card').classList.remove('opacity-40', 'pointer-events-none');
      document.getElementById('progress-card').classList.add('hidden');

      // Transcript
      document.getElementById('result-transcript').textContent = data.transcript || '(empty)';

      // Pitch stats
      const p = data.pitch;
      const stats = [
        { label:'Mean',   val: p.mean_hz.toFixed(1)   + ' Hz' },
        { label:'Min',    val: p.min_hz.toFixed(1)    + ' Hz' },
        { label:'Max',    val: p.max_hz.toFixed(1)    + ' Hz' },
        { label:'Median', val: p.median_hz.toFixed(1) + ' Hz' },
        { label:'Std',    val: p.std_hz.toFixed(1)    + ' Hz' },
        { label:'Class',  val: p.classification.toUpperCase(), accent: true },
      ];
      document.getElementById('pitch-stats').innerHTML = stats.map(s => `
        <div class="bg-slate-50 rounded-xl p-3 text-center border border-gray-100">
          <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">${s.label}</p>
          <p class="text-sm font-bold mt-1 ${s.accent ? 'text-indigo-600' : 'text-gray-700'}">${s.val}</p>
        </div>`).join('');

      // Pitch chart
      document.getElementById('pitch-chart').src = `/pitch/${jobId}?t=${Date.now()}`;

      // Diarization
      renderDiarization(data.speakers, data.duration);

      document.getElementById('results-root').classList.remove('hidden');
      document.getElementById('results-root').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderDiarization(speakers, duration) {
      const el = document.getElementById('diar-content');
      if (!speakers || speakers.length === 0) {
        el.innerHTML = '<p class="text-sm text-gray-400 italic">No diarization data available.</p>';
        return;
      }

      // Speaker index map
      const spkIdx = Object.fromEntries(speakers.map((s, i) => [s.id, i]));

      // All segments flat + sorted
      const allSegs = speakers.flatMap(s => s.segments.map(sg => ({ ...sg, speaker: s.id })))
                               .sort((a, b) => a.start - b.start);

      // Legend
      const legend = speakers.map((s, i) => `
        <div class="flex items-center gap-1.5">
          <div class="w-3 h-3 rounded-full" style="background:${SPEAKER_COLORS[i % SPEAKER_COLORS.length]}"></div>
          <span class="text-xs font-medium text-gray-600">${s.id}</span>
        </div>`).join('');

      // Timeline segments
      const bars = allSegs.map(seg => {
        const left  = (seg.start / duration * 100).toFixed(3);
        const width = Math.max(0.4, ((seg.end - seg.start) / duration * 100)).toFixed(3);
        const i     = spkIdx[seg.speaker] ?? 0;
        return `<div title="${seg.speaker}: ${seg.start.toFixed(2)}s ‚Äì ${seg.end.toFixed(2)}s"
                     style="left:${left}%;width:${width}%;background:${SPEAKER_COLORS[i % SPEAKER_COLORS.length]}"
                     class="absolute inset-y-0 rounded-sm opacity-85 hover:opacity-100 transition-opacity"></div>`;
      }).join('');

      // Time ticks (5 evenly spaced)
      const ticks = [0, 0.25, 0.5, 0.75, 1].map(f => {
        const t = (duration * f).toFixed(1);
        return `<span style="left:${(f*100).toFixed(1)}%" class="absolute -translate-x-1/2 text-xs text-gray-400">${t}s</span>`;
      }).join('');

      // Per-speaker cards
      const cards = speakers.map((spk, i) => {
        const color  = SPEAKER_COLORS[i % SPEAKER_COLORS.length];
        const bg     = SPEAKER_BG[i % SPEAKER_BG.length];
        const border = SPEAKER_BORDER[i % SPEAKER_BORDER.length];
        const segTags = spk.segments.map(s =>
          `<span class="text-xs text-gray-400 bg-white/70 rounded px-1.5 py-0.5">${s.start.toFixed(1)}‚Äì${s.end.toFixed(1)}s</span>`
        ).join(' ');
        return `
          <div class="rounded-xl border p-4" style="background:${bg};border-color:${border}">
            <div class="flex flex-wrap items-center gap-2 mb-2.5">
              <div class="w-3 h-3 rounded-full flex-shrink-0" style="background:${color}"></div>
              <span class="font-bold text-sm" style="color:${color}">${spk.id}</span>
              <span class="text-xs text-gray-400">${spk.segments.length} segment${spk.segments.length !== 1 ? 's' : ''}</span>
              <div class="ml-auto flex flex-wrap gap-1">${segTags}</div>
            </div>
            <p class="text-sm text-gray-700 leading-relaxed">
              ${spk.transcript || '<em class="text-gray-400">No transcript aligned to this speaker.</em>'}
            </p>
          </div>`;
      }).join('');

      el.innerHTML = `
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <span class="text-sm text-gray-600"><strong>${speakers.length}</strong> speaker${speakers.length !== 1 ? 's' : ''} detected</span>
          <div class="flex flex-wrap gap-3">${legend}</div>
        </div>
        <div class="relative h-8 bg-gray-100 rounded-lg overflow-hidden mb-1">${bars}</div>
        <div class="relative h-5 mb-6">${ticks}</div>
        <div class="space-y-3">${cards}</div>`;
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function copyTranscript(btn) {
      const text = document.getElementById('result-transcript').textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 1800);
      });
    }

    function showError(msg) {
      document.getElementById('upload-card').classList.remove('opacity-40', 'pointer-events-none');
      document.getElementById('progress-card').classList.add('hidden');
      alert('Error: ' + msg);
    }

    function resetUI() {
      document.getElementById('results-root').classList.add('hidden');
      document.getElementById('progress-card').classList.add('hidden');
      clearFile();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
