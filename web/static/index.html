<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 0.9s linear infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .fade-in { animation: fadeIn 0.35s ease both; }
    .drag-over { border-color: #6366f1 !important; background-color: #eef2ff !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-gray-900">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-5 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-lg">ğŸ™</div>
      <div>
        <h1 class="font-bold text-gray-900 leading-tight">Voice Analyzer</h1>
        <p class="text-xs text-gray-400">Vietnamese Â· Pitch Â· Speaker Diarization</p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-5 py-8 space-y-5">

    <!-- â”€â”€ Upload Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="upload-card" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 transition-opacity">

      <!-- Drop zone -->
      <div id="dropzone"
           class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50"
           onclick="document.getElementById('file-input').click()">
        <div class="text-4xl mb-2" id="drop-icon">ğŸ“‚</div>
        <p id="drop-label" class="font-medium text-gray-600">Drop audio file here or <span class="text-indigo-600">click to browse</span></p>
        <p class="text-xs text-gray-400 mt-1">WAV &middot; MP3 &middot; M4A &middot; FLAC &middot; OGG</p>
        <input type="file" id="file-input" accept=".wav,.mp3,.m4a,.flac,.ogg,.aac" class="hidden" />
      </div>

      <!-- File info bar -->
      <div id="file-info" class="hidden mt-4 flex items-center gap-3 bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-3">
        <span class="text-2xl">ğŸµ</span>
        <div class="flex-1 min-w-0">
          <p id="file-name" class="font-semibold text-gray-800 text-sm truncate"></p>
          <p id="file-size" class="text-xs text-gray-400"></p>
        </div>
        <button onclick="clearFile()" class="text-gray-300 hover:text-red-400 text-xl leading-none transition-colors">&times;</button>
      </div>

      <!-- Options grid -->
      <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Model</label>
          <select id="opt-model" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="tiny">Tiny</option>
            <option value="base">Base</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large" selected>Large</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Speakers</label>
          <input id="opt-speakers" type="number" min="1" max="10" placeholder="Auto"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Device</label>
          <select id="opt-device" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="auto" selected>Auto</option>
            <option value="cpu">CPU</option>
            <option value="cuda">CUDA</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Diarization</label>
          <label class="flex items-center gap-2 mt-2.5 cursor-pointer select-none">
            <input type="checkbox" id="opt-skip-diar" class="w-4 h-4 rounded accent-indigo-600" />
            <span class="text-sm text-gray-600">Skip</span>
          </label>
        </div>
      </div>

      <!-- HF Token -->
      <div class="mt-4">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">
          Hugging Face Token <span class="font-normal normal-case text-gray-400">(required for diarization)</span>
        </label>
        <input id="opt-hf-token" type="password" placeholder="hf_â€¦"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
      </div>

      <!-- Analyze button -->
      <button id="analyze-btn" onclick="startAnalysis()" disabled
              class="mt-6 w-full py-3 rounded-xl font-semibold text-sm transition-all
                     bg-gray-200 text-gray-400 cursor-not-allowed
                     disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed">
        Select a file to analyze
      </button>
    </div>

    <!-- â”€â”€ Progress Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="progress-card" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6 fade-in">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-semibold text-gray-700">Processing</h2>
        <span id="progress-filename" class="text-xs text-gray-400 truncate max-w-[200px]"></span>
      </div>
      <div id="steps-container" class="space-y-5"></div>
    </div>

    <!-- â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="results-root" class="hidden space-y-5 fade-in">

      <!-- Call Summary (MEDLATEC) -->
      <div id="summary-card" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <span class="text-indigo-500">ğŸ“‹</span> Call Summary
        </h2>
        <div id="summary-content"></div>
      </div>

      <!-- Transcript -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-700 flex items-center gap-2">
            <span class="text-indigo-500">ğŸ“</span> Transcript
          </h2>
          <button onclick="copyTranscript(this)"
                  class="text-xs text-indigo-600 hover:text-indigo-800 border border-indigo-200 hover:border-indigo-400 rounded-lg px-3 py-1 transition-colors">
            Copy
          </button>
        </div>
        <p id="result-transcript"
           class="text-sm text-gray-800 leading-relaxed bg-slate-50 rounded-xl p-4 border border-gray-100 whitespace-pre-wrap"></p>
      </div>

      <!-- Conversation Timeline -->
      <div id="conv-card" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-5 flex items-center gap-2">
          <span class="text-indigo-500">ğŸ’¬</span> Conversation Timeline
        </h2>
        <div id="conversation-timeline" class="space-y-3"></div>
      </div>

      <!-- Pitch -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-5 flex items-center gap-2">
          <span class="text-indigo-500">ğŸ“Š</span> Pitch Analysis
        </h2>
        <div id="pitch-stats" class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-5"></div>
        <img id="pitch-chart" src="" alt="Pitch contour"
             class="w-full rounded-xl border border-gray-100 bg-gray-50" />
      </div>

      <!-- Diarization -->
      <div id="diar-card" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-700 mb-5 flex items-center gap-2">
          <span class="text-indigo-500">ğŸ‘¥</span> Speaker Summary
        </h2>
        <div id="diar-content"></div>
      </div>

      <!-- Analyze another -->
      <button onclick="resetUI()"
              class="w-full py-3 rounded-xl font-semibold text-sm bg-white border border-gray-300
                     hover:border-indigo-400 hover:text-indigo-600 transition-colors text-gray-600">
        â†© Analyze Another File
      </button>
    </div>

  </main>

  <script>
    // â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SPEAKER_COLORS  = ['#6366f1','#f59e0b','#10b981','#ef4444','#8b5cf6','#06b6d4'];
    const SPEAKER_BG      = ['#eef2ff','#fffbeb','#ecfdf5','#fef2f2','#f5f3ff','#ecfeff'];
    const SPEAKER_BORDER  = ['#c7d2fe','#fde68a','#a7f3d0','#fecaca','#ddd6fe','#a5f3fc'];
    const STEP_DEFS = [
      { id:1, name:'Load & Enhance', icon:'ğŸµ' },
      { id:2, name:'Transcribe',     icon:'ğŸ“' },
      { id:3, name:'Pitch',          icon:'ğŸ“Š' },
      { id:4, name:'Diarize',        icon:'ğŸ‘¥' },
      { id:5, name:'Verify',         icon:'âœ…' },
    ];

    let selectedFile = null;

    // â”€â”€ Dropzone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dropzone  = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');

    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('drag-over');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    function handleFile(f) {
      selectedFile = f;
      document.getElementById('file-name').textContent = f.name;
      document.getElementById('file-size').textContent = fmtBytes(f.size);
      document.getElementById('file-info').classList.remove('hidden');
      document.getElementById('drop-label').innerHTML =
        'File selected &mdash; <span class="text-indigo-600">click to change</span>';
      const btn = document.getElementById('analyze-btn');
      btn.disabled = false;
      btn.className = btn.className.replace(
        /bg-gray-200 text-gray-400 cursor-not-allowed/,
        'bg-indigo-600 hover:bg-indigo-700 text-white cursor-pointer'
      );
      btn.textContent = 'Analyze Audio';
    }

    function clearFile() {
      selectedFile = null;
      fileInput.value = '';
      document.getElementById('file-info').classList.add('hidden');
      document.getElementById('drop-label').innerHTML =
        'Drop audio file here or <span class="text-indigo-600">click to browse</span>';
      const btn = document.getElementById('analyze-btn');
      btn.disabled = true;
      btn.className = btn.className.replace(
        /bg-indigo-600 hover:bg-indigo-700 text-white cursor-pointer/,
        'bg-gray-200 text-gray-400 cursor-not-allowed'
      );
      btn.textContent = 'Select a file to analyze';
    }

    function fmtBytes(b) {
      if (b < 1024) return b + ' B';
      if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
      return (b/1024/1024).toFixed(1) + ' MB';
    }

    // â”€â”€ Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startAnalysis() {
      if (!selectedFile) return;

      const fd = new FormData();
      fd.append('file', selectedFile);
      fd.append('model_size', document.getElementById('opt-model').value);
      fd.append('num_speakers', document.getElementById('opt-speakers').value);
      fd.append('device', document.getElementById('opt-device').value);
      fd.append('skip_diarization', document.getElementById('opt-skip-diar').checked ? 'true' : 'false');
      fd.append('hf_token', document.getElementById('opt-hf-token').value);

      // UI transition
      document.getElementById('upload-card').classList.add('opacity-40', 'pointer-events-none');
      document.getElementById('results-root').classList.add('hidden');
      showProgress(selectedFile.name);

      let jobId;
      try {
        const res = await fetch('/analyze', { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`Upload failed: ${res.statusText}`);
        jobId = (await res.json()).job_id;
      } catch (err) { return showError(err.message); }

      const es = new EventSource('/stream/' + jobId);
      es.onmessage = e => handleEvent(JSON.parse(e.data), jobId, es);
      es.onerror   = () => { es.close(); showError('Connection lost'); };
    }

    function handleEvent(ev, jobId, es) {
      if (ev.type === 'progress') {
        setStep(ev.step, ev.status, ev.message, ev.detail);
      } else if (ev.type === 'done') {
        es.close();
        // Mark any still-pending steps as done
        STEP_DEFS.forEach(s => {
          const badge = document.getElementById(`s-badge-${s.id}`);
          if (badge && badge.textContent === '') setStep(s.id, 'done', '', '');
        });
        setTimeout(() => renderResults(ev.results, jobId), 300);
      } else if (ev.type === 'error') {
        es.close();
        showError(ev.message);
      }
    }

    // â”€â”€ Progress rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showProgress(filename) {
      document.getElementById('progress-filename').textContent = filename;
      const c = document.getElementById('steps-container');
      c.innerHTML = STEP_DEFS.map(s => `
        <div class="flex items-start gap-4">
          <div id="s-icon-${s.id}"
               class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-lg select-none">
            ${s.icon}
          </div>
          <div class="flex-1 min-w-0 pt-1.5">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium text-gray-700">${s.name}</span>
              <span id="s-badge-${s.id}" class="text-xs px-2 py-0.5 rounded-full font-medium hidden"></span>
            </div>
            <p id="s-detail-${s.id}" class="text-xs text-gray-400 mt-0.5 truncate"></p>
          </div>
        </div>`).join('');
      document.getElementById('progress-card').classList.remove('hidden');
    }

    function setStep(id, status, message, detail) {
      const icon  = document.getElementById(`s-icon-${id}`);
      const badge = document.getElementById(`s-badge-${id}`);
      const det   = document.getElementById(`s-detail-${id}`);
      if (!icon) return;
      if (detail) det.textContent = detail;

      const configs = {
        running: {
          bg:    'bg-indigo-100',
          inner: `<svg class="w-5 h-5 text-indigo-600 spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                  </svg>`,
          badgeCls: 'bg-indigo-100 text-indigo-700', badgeText: 'Running',
        },
        done: {
          bg:    'bg-green-100',
          inner: '<span class="text-green-600 text-xl font-bold">âœ“</span>',
          badgeCls: 'bg-green-100 text-green-700', badgeText: 'Done',
        },
        warning: {
          bg:    'bg-amber-100',
          inner: '<span class="text-amber-500 text-xl">âš </span>',
          badgeCls: 'bg-amber-100 text-amber-700', badgeText: 'Skipped',
        },
        skipped: {
          bg:    'bg-gray-100',
          inner: '<span class="text-gray-400 text-lg">â€”</span>',
          badgeCls: 'bg-gray-100 text-gray-500', badgeText: 'Skipped',
        },
      };

      const cfg = configs[status];
      if (!cfg) return;
      icon.className = `flex-shrink-0 w-10 h-10 rounded-full ${cfg.bg} flex items-center justify-center`;
      icon.innerHTML = cfg.inner;
      badge.className = `text-xs px-2 py-0.5 rounded-full font-medium ${cfg.badgeCls}`;
      badge.textContent = cfg.badgeText;
      badge.classList.remove('hidden');
    }

    // â”€â”€ Results rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderResults(data, jobId) {
      document.getElementById('upload-card').classList.remove('opacity-40', 'pointer-events-none');
      document.getElementById('progress-card').classList.add('hidden');

      // Transcript
      document.getElementById('result-transcript').textContent = data.transcript || '(empty)';

      // Pitch stats
      const p = data.pitch;
      const stats = [
        { label:'Mean',   val: p.mean_hz.toFixed(1)   + ' Hz' },
        { label:'Min',    val: p.min_hz.toFixed(1)    + ' Hz' },
        { label:'Max',    val: p.max_hz.toFixed(1)    + ' Hz' },
        { label:'Median', val: p.median_hz.toFixed(1) + ' Hz' },
        { label:'Std',    val: p.std_hz.toFixed(1)    + ' Hz' },
        { label:'Class',  val: p.classification.toUpperCase(), accent: true },
      ];
      document.getElementById('pitch-stats').innerHTML = stats.map(s => `
        <div class="bg-slate-50 rounded-xl p-3 text-center border border-gray-100">
          <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">${s.label}</p>
          <p class="text-sm font-bold mt-1 ${s.accent ? 'text-indigo-600' : 'text-gray-700'}">${s.val}</p>
        </div>`).join('');

      // Pitch chart
      document.getElementById('pitch-chart').src = `/pitch/${jobId}?t=${Date.now()}`;

      // Conversation timeline
      renderConversation(data.conversation);

      // Call summary (MEDLATEC)
      renderCallSummary(data.call_summary);

      // Diarization summary
      renderDiarization(data.speakers, data.duration);

      // Hide conv-card if no conversation data
      document.getElementById('conv-card').classList.toggle('hidden', !data.conversation || data.conversation.length === 0);

      document.getElementById('results-root').classList.remove('hidden');
      document.getElementById('results-root').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // â”€â”€ Conversation timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderConversation(conversation) {
      const el = document.getElementById('conversation-timeline');
      if (!conversation || conversation.length === 0) {
        el.innerHTML = '<p class="text-sm text-gray-400 italic">No conversation data.</p>';
        return;
      }

      const fmtTime = t => {
        const m = Math.floor(t / 60);
        const s = Math.floor(t % 60).toString().padStart(2, '0');
        const ms = Math.round((t % 1) * 10);
        return `${m}:${s}.${ms}`;
      };

      const ROLE_STYLE = {
        agent: {
          wrap:   'items-start',
          bubble: 'bg-indigo-50 border-indigo-100 rounded-tl-sm',
          label:  'ğŸ§ Agent',
          labelCls: 'text-indigo-700 bg-indigo-100',
        },
        customer: {
          wrap:   'items-end',
          bubble: 'bg-amber-50 border-amber-100 rounded-tr-sm',
          label:  'ğŸ‘¤ Customer',
          labelCls: 'text-amber-700 bg-amber-100',
        },
        unknown: {
          wrap:   'items-start',
          bubble: 'bg-gray-50 border-gray-100 rounded-tl-sm',
          label:  '',
          labelCls: '',
        },
      };

      el.innerHTML = conversation.map(utt => {
        const rs = ROLE_STYLE[utt.role] || ROLE_STYLE.unknown;
        const timeStr = `${fmtTime(utt.start)} â€“ ${fmtTime(utt.end)}`;
        const isCustomer = utt.role === 'customer';

        const roleBadge = rs.label
          ? `<span class="text-xs px-2 py-0.5 rounded-full font-semibold ${rs.labelCls}">${rs.label}</span>`
          : '';

        const highToneBadge = utt.high_tone
          ? `<span class="text-xs px-1.5 py-0.5 rounded-full bg-orange-100 text-orange-600 font-medium" title="Elevated pitch detected">â†‘ ${utt.avg_pitch_hz} Hz</span>`
          : '';

        const metaRow = isCustomer
          ? `<div class="flex items-center justify-end gap-2 mb-1">
               ${highToneBadge}
               <span class="text-xs text-gray-400">${timeStr}</span>
               ${roleBadge}
             </div>`
          : `<div class="flex items-center gap-2 mb-1">
               ${roleBadge}
               <span class="text-xs text-gray-400">${timeStr}</span>
               ${highToneBadge}
             </div>`;

        const ringCls = utt.high_tone ? 'ring-1 ring-orange-200' : '';

        return `
          <div class="flex flex-col ${rs.wrap}">
            ${metaRow}
            <div class="max-w-[82%] rounded-2xl ${rs.bubble} border px-4 py-2.5 ${ringCls}">
              <p class="text-sm text-gray-800 leading-relaxed">${utt.text}</p>
            </div>
          </div>`;
      }).join('');
    }

    // â”€â”€ Call Summary (MEDLATEC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCallSummary(summary) {
      const card = document.getElementById('summary-card');
      const el   = document.getElementById('summary-content');

      if (!summary) { card.classList.add('hidden'); return; }
      card.classList.remove('hidden');

      const INTENT_LABELS = {
        ask_test_result:   { icon: 'ğŸ§ª', label: 'Ask Test Result',       color: 'text-purple-700 bg-purple-100' },
        schedule_home:     { icon: 'ğŸ ', label: 'Schedule â€“ At Home',     color: 'text-emerald-700 bg-emerald-100' },
        schedule_hospital: { icon: 'ğŸ¥', label: 'Schedule â€“ At Hospital', color: 'text-blue-700 bg-blue-100' },
        service_inquiry:   { icon: 'â“', label: 'Service Inquiry',         color: 'text-amber-700 bg-amber-100' },
        other:             { icon: 'ğŸ’¬', label: 'Other',                   color: 'text-gray-600 bg-gray-100' },
      };

      const OUTCOME_LABELS = {
        result_not_ready:             'â³ Result Not Ready',
        result_provided:              'âœ… Result Provided',
        result_status_unclear:        'â” Result Status Unclear',
        appointment_confirmed_home:   'âœ… Appointment Confirmed (Home)',
        appointment_confirmed_hospital: 'âœ… Appointment Confirmed (Hospital)',
        appointment_pending:          'â³ Appointment Pending',
        appointment_status_unclear:   'â” Appointment Status Unclear',
        inquiry_handled:              'âœ… Inquiry Handled',
        inquiry_status_unclear:       'â” Inquiry Status Unclear',
        unknown:                      'â” Unknown',
      };

      const intent = INTENT_LABELS[summary.intent] || INTENT_LABELS.other;
      const outcomeText = OUTCOME_LABELS[summary.outcome_hint] || summary.outcome_hint;

      // Entities block
      const ents = summary.entities || {};
      const entityRows = [];
      if ((ents.phones || []).length)  entityRows.push({ k: 'ğŸ“ Phone',    v: ents.phones.join(', ') });
      if ((ents.tests  || []).length)  entityRows.push({ k: 'ğŸ§¬ Tests',    v: ents.tests.join(', ') });
      if ((ents.times  || []).length)  entityRows.push({ k: 'ğŸ• Time',     v: ents.times.join(', ') });
      if ((ents.areas  || []).length)  entityRows.push({ k: 'ğŸ“ Area',     v: ents.areas.join(', ') });
      if (ents.location_type)          entityRows.push({ k: 'ğŸ“Œ Location', v: ents.location_type === 'home' ? 'ğŸ  Home' : 'ğŸ¥ Hospital' });

      const entityTable = entityRows.length
        ? `<div class="mt-4 space-y-1.5">
             ${entityRows.map(r => `
               <div class="flex gap-3 text-sm">
                 <span class="text-gray-400 w-24 flex-shrink-0">${r.k}</span>
                 <span class="text-gray-800 font-medium">${r.v}</span>
               </div>`).join('')}
           </div>`
        : '<p class="text-xs text-gray-400 mt-2">No entities detected.</p>';

      // Stats row
      const fmtDur = s => { const m = Math.floor(s/60); return m ? `${m}m ${Math.round(s%60)}s` : `${Math.round(s)}s`; };
      const statsItems = [
        { label: 'Duration',       val: fmtDur(summary.duration_s) },
        { label: 'Total Turns',    val: summary.turn_count },
        { label: 'Agent Turns',    val: summary.agent_turns },
        { label: 'Customer Turns', val: summary.customer_turns },
        { label: 'High-Tone',      val: summary.high_tone_turns, accent: summary.high_tone_turns > 0 },
      ];

      el.innerHTML = `
        <!-- Intent + Outcome row -->
        <div class="flex flex-wrap items-start gap-3 mb-4">
          <div>
            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide mb-1">Intent</p>
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-semibold ${intent.color}">
              ${intent.icon} ${intent.label}
            </span>
          </div>
          <div>
            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide mb-1">Outcome</p>
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
              ${outcomeText}
            </span>
          </div>
        </div>

        <!-- Stats tiles -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2">
          ${statsItems.map(s => `
            <div class="bg-slate-50 rounded-xl p-3 text-center border border-gray-100">
              <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">${s.label}</p>
              <p class="text-sm font-bold mt-1 ${s.accent ? 'text-orange-500' : 'text-gray-700'}">${s.val}</p>
            </div>`).join('')}
        </div>

        <!-- Entities -->
        <div class="mt-4 border-t border-gray-100 pt-4">
          <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide mb-2">Entities Detected</p>
          ${entityTable}
        </div>`;
    }

    // â”€â”€ Speaker summary (diarization card) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDiarization(speakers, duration) {
      const el = document.getElementById('diar-content');
      if (!speakers || speakers.length === 0) {
        el.innerHTML = '<p class="text-sm text-gray-400 italic">No diarization data available.</p>';
        return;
      }

      const ROLE_BADGE = {
        agent:    '<span class="text-xs px-2 py-0.5 rounded-full font-semibold text-indigo-700 bg-indigo-100">ğŸ§ Agent</span>',
        customer: '<span class="text-xs px-2 py-0.5 rounded-full font-semibold text-amber-700 bg-amber-100">ğŸ‘¤ Customer</span>',
      };

      const spkIdx = Object.fromEntries(speakers.map((s, i) => [s.id, i]));

      const allSegs = speakers.flatMap(s => s.segments.map(sg => ({ ...sg, speaker: s.id })))
                               .sort((a, b) => a.start - b.start);

      // Legend
      const legend = speakers.map((s, i) => `
        <div class="flex items-center gap-1.5">
          <div class="w-3 h-3 rounded-full" style="background:${SPEAKER_COLORS[i % SPEAKER_COLORS.length]}"></div>
          <span class="text-xs font-medium text-gray-600">${s.id}</span>
          ${ROLE_BADGE[s.role] || ''}
        </div>`).join('');

      // Timeline bar
      const bars = allSegs.map(seg => {
        const left  = (seg.start / duration * 100).toFixed(3);
        const width = Math.max(0.4, ((seg.end - seg.start) / duration * 100)).toFixed(3);
        const i     = spkIdx[seg.speaker] ?? 0;
        return `<div title="${seg.speaker}: ${seg.start.toFixed(2)}s â€“ ${seg.end.toFixed(2)}s"
                     style="left:${left}%;width:${width}%;background:${SPEAKER_COLORS[i % SPEAKER_COLORS.length]}"
                     class="absolute inset-y-0 rounded-sm opacity-85 hover:opacity-100 transition-opacity"></div>`;
      }).join('');

      const ticks = [0, 0.25, 0.5, 0.75, 1].map(f => {
        const t = (duration * f).toFixed(1);
        return `<span style="left:${(f*100).toFixed(1)}%" class="absolute -translate-x-1/2 text-xs text-gray-400">${t}s</span>`;
      }).join('');

      // Per-speaker summary cards
      const cards = speakers.map((spk, i) => {
        const color  = SPEAKER_COLORS[i % SPEAKER_COLORS.length];
        const bg     = SPEAKER_BG[i % SPEAKER_BG.length];
        const border = SPEAKER_BORDER[i % SPEAKER_BORDER.length];
        const segTags = spk.segments.map(s =>
          `<span class="text-xs text-gray-400 bg-white/70 rounded px-1.5 py-0.5">${s.start.toFixed(1)}â€“${s.end.toFixed(1)}s</span>`
        ).join(' ');
        const roleBadge = ROLE_BADGE[spk.role] || '';
        return `
          <div class="rounded-xl border p-4" style="background:${bg};border-color:${border}">
            <div class="flex flex-wrap items-center gap-2 mb-2.5">
              <div class="w-3 h-3 rounded-full flex-shrink-0" style="background:${color}"></div>
              <span class="font-bold text-sm" style="color:${color}">${spk.id}</span>
              ${roleBadge}
              <span class="text-xs text-gray-400">${spk.segments.length} segment${spk.segments.length !== 1 ? 's' : ''}</span>
              <div class="ml-auto flex flex-wrap gap-1">${segTags}</div>
            </div>
            <p class="text-sm text-gray-700 leading-relaxed">
              ${spk.transcript || '<em class="text-gray-400">No transcript available.</em>'}
            </p>
          </div>`;
      }).join('');

      el.innerHTML = `
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <span class="text-sm text-gray-600"><strong>${speakers.length}</strong> speaker${speakers.length !== 1 ? 's' : ''} detected</span>
          <div class="flex flex-wrap gap-3">${legend}</div>
        </div>
        <div class="relative h-8 bg-gray-100 rounded-lg overflow-hidden mb-1">${bars}</div>
        <div class="relative h-5 mb-6">${ticks}</div>
        <div class="space-y-3">${cards}</div>`;
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyTranscript(btn) {
      const text = document.getElementById('result-transcript').textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 1800);
      });
    }

    function showError(msg) {
      document.getElementById('upload-card').classList.remove('opacity-40', 'pointer-events-none');
      document.getElementById('progress-card').classList.add('hidden');
      alert('Error: ' + msg);
    }

    function resetUI() {
      document.getElementById('results-root').classList.add('hidden');
      document.getElementById('progress-card').classList.add('hidden');
      clearFile();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
